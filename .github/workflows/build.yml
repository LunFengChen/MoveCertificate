name: Build Module

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# 使用方法：
# 把证书文件放到 certificates/ 目录，push 触发构建
# 支持格式: .pem .crt .cer .0

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r25c
    
    - name: Build cert-hash tool
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        mkdir -p bin
        TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        echo "Building cert-hash for arm64..."
        $TOOLCHAIN/bin/aarch64-linux-android21-clang -static -O2 -o bin/cert-hash-arm64 tools/cert-hash.c
        echo "Building cert-hash for arm..."
        $TOOLCHAIN/bin/armv7a-linux-androideabi21-clang -static -O2 -o bin/cert-hash-arm tools/cert-hash.c
        ls -la bin/
    
    - name: Process certificates
      id: certs
      shell: bash
      run: |
        CERT_HASHES=""
        
        # 只处理仓库中已有的 certificates/ 目录
        if [ -d "certificates" ] && [ "$(ls -A certificates 2>/dev/null)" ]; then
          echo "Found certificates in repo"
          for cert in certificates/*; do
            [ -f "$cert" ] || continue
            filename=$(basename "$cert")
            ext="${filename##*.}"
            
            if [ "$ext" = "0" ]; then
              # 已经是 .0 格式
              HASH="${filename%.0}"
            elif [ "$ext" = "pem" ] || [ "$ext" = "crt" ] || [ "$ext" = "cer" ]; then
              # 需要转换
              HASH=$(openssl x509 -subject_hash_old -noout -in "$cert" 2>/dev/null) || continue
              openssl x509 -in "$cert" -out "certificates/${HASH}.0" 2>/dev/null || continue
              rm -f "$cert"
              echo "Converted: $filename -> ${HASH}.0"
            else
              continue
            fi
            
            if [ -n "$CERT_HASHES" ]; then
              CERT_HASHES="${CERT_HASHES}-${HASH}"
            else
              CERT_HASHES="${HASH}"
            fi
          done
        fi
        
        echo "=== Certificates ==="
        ls -la certificates/ 2>/dev/null || echo "No certificates"
        echo "cert_hashes=$CERT_HASHES" >> $GITHUB_OUTPUT
    
    - name: Get version
      id: version
      run: |
        CERT_HASHES="${{ steps.certs.outputs.cert_hashes }}"
        
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          # tag 触发：使用 tag 名
          VERSION=${GITHUB_REF#refs/tags/}
        elif [[ -n "$CERT_HASHES" ]]; then
          # 手动触发且有证书：使用 hash 拼接
          VERSION="v1.0.0-${CERT_HASHES}"
        else
          # 其他情况：使用 commit hash
          VERSION="v1.0.0-$(git rev-parse --short HEAD)"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Build module
      run: |
        chmod +x build.sh
        ls -la
        ls -la bin/ || true
        ls -la certificates/ || true
        if [ -d "certificates" ] && [ "$(ls -A certificates 2>/dev/null)" ]; then
          ./build.sh -v ${{ steps.version.outputs.version }} -c ./certificates
        else
          ./build.sh -v ${{ steps.version.outputs.version }}
        fi
        # 验证 zip 结构
        unzip -l MoveCertificate-*.zip | head -20
    
    - name: Prepare artifact
      run: |
        # 解压 zip 到临时目录，避免 artifact 多一层
        mkdir -p artifact
        unzip MoveCertificate-*.zip -d artifact/
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MoveCertificate-${{ steps.version.outputs.version }}
        path: artifact/*
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'push' && github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && steps.version.outputs.version || 'latest' }}
        name: ${{ startsWith(github.ref, 'refs/tags/') && steps.version.outputs.version || 'Latest Build' }}
        files: MoveCertificate-*.zip
        generate_release_notes: true
        prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
